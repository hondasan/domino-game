<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Domino Critical V14</title>
    <!-- 物理演算ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #050505;
            color: white;
            font-family: 'Verdana', sans-serif;
            overflow: hidden;
            touch-action: none;
            height: 100vh;
            width: 100vw;
            user-select: none;
            -webkit-user-select: none;
            position: relative;
        }

        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: block;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 10;
        }

        .header {
            padding: 20px;
            text-align: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            position: relative;
            height: 100px;
        }

        #force-finish-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            pointer-events: auto;
            background: rgba(255, 0, 85, 0.4);
            border: 2px solid rgba(255, 0, 85, 1);
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            z-index: 9999;
            box-shadow: 0 0 10px rgba(255,0,85,0.5);
            display: none; 
        }
        #force-finish-btn:active { background: rgba(255, 0, 85, 0.8); transform: scale(0.95); }

        .score-box {
            font-size: 48px;
            font-weight: 900;
            color: #00ffcc;
            text-shadow: 0 0 15px rgba(0, 255, 204, 0.8);
            letter-spacing: 1px;
            font-variant-numeric: tabular-nums;
        }

        .sub-info {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            text-transform: uppercase;
        }

        #message-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: auto;
            width: 90%;
            max-width: 400px;
            background: rgba(10, 10, 10, 0.95);
            padding: 30px 20px;
            border-radius: 20px;
            border: 1px solid #444;
            box-shadow: 0 0 40px rgba(0,255,204,0.1);
        }

        .btn-start {
            font-size: 28px;
            font-weight: bold;
            color: #000;
            background: #00ffcc;
            padding: 15px 40px;
            border-radius: 50px;
            border: none;
            box-shadow: 0 0 20px #00ffcc;
            cursor: pointer;
            animation: pulse 1.5s infinite;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .jackpot-text {
            position: absolute;
            font-weight: 900;
            pointer-events: none;
            text-shadow: 0 0 10px #000;
            white-space: nowrap;
            z-index: 100;
            animation: floatUp 1.0s ease-out forwards;
        }

        .new-record {
            font-size: 24px;
            color: #ff0055;
            font-weight: 900;
            text-shadow: 0 0 10px #ff0055;
            margin-bottom: 10px;
            animation: flash 0.5s infinite alternate;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 204, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(0, 255, 204, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 204, 0); }
        }
        
        @keyframes floatUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            10% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(1.0); opacity: 0; }
        }

        @keyframes flash {
            0% { opacity: 0.5; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.1); text-shadow: 0 0 20px #ff0055, 0 0 40px #ffcc00; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="header">
            <div id="score" class="score-box">0</div>
            <div class="sub-info">
                Best: <span id="high-score">0</span><br>
                Balls: <span id="ball-count">0</span>
            </div>
            <button id="force-finish-btn">FINISH</button>
        </div>
        <div id="message-area">
            <button id="start-btn" class="btn-start">TAP TO START</button>
            <div style="margin-top:15px; font-size:11px; color:#888;">
                V14: REFRESHING SOUND
            </div>
        </div>
    </div>

<script>
    // --- CONFIG V14 ---
    const CONFIG = {
        superJackpotChance: 0.001, // 0.1% (100個)
        miniJackpotChance: 0.01,   // 1.0% (10個)
        x1000Chance: 0.0002,       // 0.02% (x1000 GOD BALL)
        x100Chance: 0.005,         // 0.5% (x100 BALL)
        splitChance: 0.20,         // 20%
        
        ballSize: 4.5,
        pegSize: 4.0,
        gravity: 1.1,
        bounciness: 0.8,
        
        baseScore: 100,
        x100Multiplier: 100,
        x1000Multiplier: 1000
    };

    const PALETTE = [
        { color: '#00ffff', note: 0,  type: 'sine' },     
        { color: '#00ffaa', note: 2,  type: 'sine' },     
        { color: '#ffff00', note: 4,  type: 'triangle' }, 
        { color: '#ffaa00', note: 7,  type: 'sine' },     
        { color: '#ff0055', note: 9,  type: 'triangle' }, 
        { color: '#aa00ff', note: 12, type: 'sine' },     
        { color: '#ffffff', note: 14, type: 'square' }    
    ];

    let engine, render, runner, world;
    let score = 0;
    let highScore = parseInt(localStorage.getItem('domino_critical_highscore_v12')) || 0;
    
    let isPlaying = false;
    let hasStarted = false; 
    let ballCount = 0;
    let audioCtx = null;

    const scoreEl = document.getElementById('score');
    const highScoreEl = document.getElementById('high-score');
    const ballCountEl = document.getElementById('ball-count');
    const startBtn = document.getElementById('start-btn');
    const msgArea = document.getElementById('message-area');
    const finishBtn = document.getElementById('force-finish-btn');

    highScoreEl.textContent = highScore.toLocaleString();

    const { Engine, Render, Runner, Bodies, Composite, Events, Body } = Matter;

    // --- Advanced Sound System (V14) ---
    const Sound = {
        init: () => {
            if (!audioCtx) {
                const AC = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AC();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        },
        
        // playTone: ball collisions
        playTone: (noteIndex, waveType, ballType) => {
            if (!audioCtx) return;
            
            // 間引き処理
            const isRare = (ballType === 'x100' || ballType === 'x1000');
            if (!isRare) {
                if (ballCount > 100 && Math.random() < 0.7) return; 
            }

            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            if (ballType === 'x1000') {
                // GOD SOUND: Shimmering high sine
                osc.type = 'sine';
                osc.frequency.setValueAtTime(2000, t);
                osc.frequency.exponentialRampToValueAtTime(1000, t + 0.3);
                gain.gain.setValueAtTime(0.15, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
            } else if (ballType === 'x100') {
                // REFRESHING SOUND: Positive Upsweep (Coin get!)
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(880, t);
                osc.frequency.linearRampToValueAtTime(1760, t + 0.1); // 上昇音
                gain.gain.setValueAtTime(0.2, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
            } else {
                // NORMAL
                const baseFreq = 523.25;
                const freq = baseFreq * Math.pow(2, noteIndex / 12);
                osc.type = waveType || 'sine';
                osc.frequency.setValueAtTime(freq, t);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
            }

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(t + 0.6);
        },

        // playJackpot: Cyber & Futuristic
        playJackpot: (type) => {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;

            // Helper for oscillators
            const playOsc = (type, freq, start, dur, vol, slideTo = null) => {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = type;
                o.frequency.setValueAtTime(freq, start);
                if (slideTo) {
                    o.frequency.exponentialRampToValueAtTime(slideTo, start + dur);
                }
                g.gain.setValueAtTime(vol, start);
                g.gain.exponentialRampToValueAtTime(0.001, start + dur);
                o.connect(g);
                g.connect(audioCtx.destination);
                o.start(start);
                o.stop(start + dur + 0.1);
            };

            if(type === 'super') {
                // SUPER JACKPOT: Cyber Riser + Arpeggio
                playOsc('sawtooth', 200, t, 1.2, 0.15, 4000);
                
                const notes = [880, 1108, 1318, 1760]; 
                for(let i=0; i<16; i++) {
                    playOsc('square', notes[i%4], t + i*0.06, 0.08, 0.08);
                }
                
                playOsc('sine', 100, t, 1.5, 0.5, 30);

            } else if (type === 'x1000') {
                // GOD CHORD
                const freqs = [523.25, 659.25, 783.99, 987.77, 1174.66];
                freqs.forEach((f, i) => {
                    playOsc('triangle', f, t, 2.0, 0.1); 
                    playOsc('sine', f * 1.01, t, 2.0, 0.1); 
                });
                playOsc('sine', 2093.00, t, 2.5, 0.05);

            } else if (type === 'x100') {
                // REFRESHING SPAWN: Major Arpeggio (Lucky!)
                // C E G C
                const notes = [523.25, 659.25, 783.99, 1046.50]; 
                notes.forEach((f, i) => {
                     playOsc('sine', f, t + i*0.05, 0.2, 0.1);
                });

            } else {
                // Mini Jackpot
                playOsc('sine', 1046.50, t, 0.2, 0.1);
                playOsc('sine', 1567.98, t+0.1, 0.3, 0.1); 
                playOsc('square', 2093.00, t+0.2, 0.4, 0.05); 
            }
        }
    };

    function init() {
        engine = Engine.create();
        world = engine.world;
        engine.gravity.y = CONFIG.gravity;

        render = Render.create({
            element: document.body,
            engine: engine,
            options: {
                width: window.innerWidth,
                height: window.innerHeight,
                wireframes: false,
                background: '#050505',
                pixelRatio: 1 
            }
        });
        render.canvas.id = "game-canvas";
        
        createStage();

        Events.on(engine, 'collisionStart', handleCollision);
        Events.on(engine, 'beforeUpdate', handleGameLoop);

        Render.run(render);
        runner = Runner.create();
        Runner.run(runner, engine);

        window.addEventListener('resize', () => {
            render.canvas.width = window.innerWidth;
            render.canvas.height = window.innerHeight;
            if(!isPlaying) createStage();
        });

        startBtn.addEventListener('click', startGame);
        finishBtn.addEventListener('click', () => { if(isPlaying) endGame(); });
    }

    function createStage() {
        const bodies = Composite.allBodies(world);
        const stageBodies = bodies.filter(b => b.label === 'peg' || b.label === 'wall');
        Composite.remove(world, stageBodies);
        createPegs();
        createWalls();
    }

    function createPegs() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        if (width < 100) return;

        const cols = Math.floor(width / 30); 
        const rows = Math.floor(height / 45);
        const startY = 130; 
        
        for (let r = 0; r < rows - 1; r++) {
            for (let c = 0; c < cols + 1; c++) {
                const offset = (r % 2 === 0) ? 0 : 15;
                const x = (c * 30) + offset;
                const y = startY + (r * 45);
                
                if (x > 20 && x < width - 20) {
                    const peg = Bodies.circle(x, y, CONFIG.pegSize, {
                        isStatic: true, label: 'peg', restitution: 0.8, 
                        render: { 
                            fillStyle: '#004444', 
                            strokeStyle: '#00ffcc', 
                            lineWidth: 2
                        }
                    });
                    Composite.add(world, peg);
                }
            }
        }
    }

    function createWalls() {
        const w = window.innerWidth;
        const h = window.innerHeight;
        const opts = { isStatic: true, label: 'wall', render: { visible: false } }; 
        Composite.add(world, [
            Bodies.rectangle(0, h/2, 20, h, opts),
            Bodies.rectangle(w, h/2, 20, h, opts)
        ]);
    }

    function startGame() {
        if (isPlaying) return;
        Sound.init();
        cleanupBalls();
        createStage();
        
        score = 0;
        ballCount = 0;
        hasStarted = false;
        isPlaying = true;
        
        updateUI();
        
        msgArea.classList.add('hidden');
        finishBtn.style.display = 'block'; 
        
        spawnBall(window.innerWidth / 2, 40, 'master');
        hasStarted = true;
    }

    function cleanupBalls() {
        const bodies = Composite.allBodies(world);
        const balls = bodies.filter(b => b.label === 'ball');
        if(balls.length > 0) Composite.remove(world, balls);
    }

    function spawnBall(x, y, type = 'normal') {
        if (!isPlaying) return;

        let style;
        let ballType = type; // normal, x100, x1000
        
        if (type === 'master') {
            style = { color: '#ffffff', note: 12, type: 'square' };
            ballType = 'normal'; // マスターボール自体の性能は普通
        } else if (type === 'super') {
            style = { color: '#ffffff', note: 14, type: 'sawtooth' }; 
            ballType = 'normal'; // エフェクト用
        } else if (type === 'mini') {
            style = { color: '#ffcc00', note: 9, type: 'square' }; 
            ballType = 'normal';
        } else if (type === 'x1000') {
            // GOD BALL STYLE
            style = { color: '#aa00ff', note: 20, type: 'sine' }; // Purple
        } else if (type === 'x100') {
            // X100 BALL STYLE
            style = { color: '#ff0000', note: -5, type: 'sawtooth' }; // Red
        } else {
            style = PALETTE[Math.floor(Math.random() * PALETTE.length)];
        }

        const ball = Bodies.circle(x, y, CONFIG.ballSize, {
            restitution: CONFIG.bounciness,
            friction: 0.000,
            frictionAir: 0.005,
            label: 'ball',
            render: { 
                fillStyle: style.color,
                strokeStyle: (ballType === 'x1000') ? '#ffffff' : (ballType === 'x100' ? '#ffff00' : 'transparent'),
                lineWidth: (ballType === 'x1000' || ballType === 'x100') ? 2 : 0
            },
            plugin: { 
                note: style.note, 
                wave: style.type, 
                ballType: ballType
            }
        });

        Body.setVelocity(ball, { 
            x: (Math.random() - 0.5) * 8, y: (Math.random() - 0.5) * 8 
        });

        Composite.add(world, ball);
    }

    function showFloatingText(text, x, y, type) {
        if(!isPlaying) return;
        const div = document.createElement('div');
        div.className = 'jackpot-text';
        div.innerText = text;
        div.style.left = x + 'px';
        div.style.top = y + 'px';
        
        if(type === 'super') {
            div.style.fontSize = '36px'; div.style.color = '#fff'; div.style.textShadow = '0 0 20px gold';
        } else if (type === 'x1000') {
            div.style.fontSize = '40px'; div.style.color = '#aa00ff'; div.style.textShadow = '0 0 20px #fff';
        } else if (type === 'x100') {
            div.style.fontSize = '28px'; div.style.color = '#ff0000'; div.style.textShadow = '0 0 10px yellow';
        } else if (type === 'mini') {
            div.style.fontSize = '24px'; div.style.color = '#ffcc00';
        } else {
            div.style.fontSize = '16px'; div.style.color = '#fff';
        }
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1200);
    }

    function handleCollision(event) {
        if (!isPlaying) return;
        event.pairs.forEach(pair => {
            const bodyA = pair.bodyA;
            const bodyB = pair.bodyB;

            if ((bodyA.label === 'ball' && bodyB.label === 'peg') || 
                (bodyB.label === 'ball' && bodyA.label === 'peg')) {
                
                const ball = bodyA.label === 'ball' ? bodyA : bodyB;
                const peg = bodyA.label === 'peg' ? bodyA : bodyB;

                // --- Score & Sound ---
                let hitScore = CONFIG.baseScore;
                const bType = ball.plugin ? ball.plugin.ballType : 'normal';

                if (bType === 'x1000') {
                    hitScore = CONFIG.baseScore * CONFIG.x1000Multiplier;
                } else if (bType === 'x100') {
                    hitScore = CONFIG.baseScore * CONFIG.x100Multiplier;
                }
                
                // Play sound (pass ballType)
                if(ball.plugin) Sound.playTone(ball.plugin.note, ball.plugin.wave, bType);
                
                score += hitScore;

                // Visual Bounce
                if (Math.random() > 0.6 || bType === 'x1000') {
                    peg.render.fillStyle = ball.render.fillStyle;
                    peg.render.strokeStyle = '#fff';
                    setTimeout(() => { 
                        peg.render.fillStyle = '#004444'; 
                        peg.render.strokeStyle = '#00ffcc';
                    }, 100);
                }

                // --- Gacha Logic ---
                const rand = Math.random();
                
                // 1. SUPER JACKPOT (0.1%)
                if (rand < CONFIG.superJackpotChance) {
                    Sound.playJackpot('super');
                    score += 100000;
                    showFloatingText("SUPER JACKPOT!!!", window.innerWidth/2, window.innerHeight/3, 'super');
                    let created = 0;
                    const burst = () => {
                        if (!isPlaying) return; 
                        for(let k=0; k<5; k++) { 
                            if(created >= 100) return;
                            const spawnT = (bType !== 'normal' && Math.random() < 0.1) ? bType : 'super';
                            spawnBall(ball.position.x, ball.position.y, spawnT);
                            created++;
                        }
                        if(created < 100) requestAnimationFrame(burst);
                    };
                    burst();
                } 
                // 2. x1000 GOD BALL (0.02%)
                else if (rand < CONFIG.superJackpotChance + CONFIG.x1000Chance) {
                    Sound.playJackpot('x1000');
                    showFloatingText("GOD BALL x1000", ball.position.x, ball.position.y, 'x1000');
                    spawnBall(ball.position.x, ball.position.y, 'x1000');
                }
                // 3. x100 BALL (0.5%)
                else if (rand < CONFIG.superJackpotChance + CONFIG.x1000Chance + CONFIG.x100Chance) {
                    Sound.playJackpot('x100');
                    showFloatingText("x100 BALL!!", ball.position.x, ball.position.y, 'x100');
                    spawnBall(ball.position.x, ball.position.y, 'x100');
                }
                // 4. MINI JACKPOT (1.0%)
                else if (rand < CONFIG.superJackpotChance + CONFIG.x1000Chance + CONFIG.x100Chance + CONFIG.miniJackpotChance) {
                    Sound.playJackpot('mini');
                    score += 5000;
                    showFloatingText("LUCKY 10!", ball.position.x, ball.position.y, 'mini');
                    for(let i=0; i<10; i++) {
                        spawnBall(ball.position.x, ball.position.y, bType === 'normal' ? 'mini' : bType);
                    }
                }
                // 5. NORMAL SPLIT (20%)
                else if (rand < CONFIG.superJackpotChance + CONFIG.x1000Chance + CONFIG.x100Chance + CONFIG.miniJackpotChance + CONFIG.splitChance) {
                    score += 500;
                    spawnBall(ball.position.x, ball.position.y, bType);
                }
            }
        });
    }

    function handleGameLoop() {
        if (!isPlaying) return;

        const bodies = Composite.allBodies(world);
        const h = window.innerHeight;
        let currentBallCount = 0;
        
        for (let i = 0; i < bodies.length; i++) {
            const b = bodies[i];
            if (b.label === 'ball') {
                if(b.position.y > h + 10) {
                    Composite.remove(world, b);
                } else {
                    currentBallCount++;
                }
            }
        }
        
        ballCount = currentBallCount;
        if (hasStarted && ballCount === 0) endGame();
        if (engine.timing.timestamp % 200 < 20) updateUI();
    }

    function endGame() {
        if (!isPlaying) return;
        isPlaying = false; 
        finishBtn.style.display = 'none'; 

        // ハイスコア判定
        let isNewRecord = false;
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('domino_critical_highscore_v12', highScore);
            highScoreEl.textContent = Number(highScore).toLocaleString();
            isNewRecord = true;
        }

        startBtn.textContent = "RETRY";
        msgArea.innerHTML = '';
        msgArea.appendChild(startBtn);
        
        // NEW RECORD演出
        let recordHtml = isNewRecord ? '<div class="new-record">NEW RECORD!!</div>' : '<div style="margin-top:20px; font-size:14px; color:#aaa;">RESULT</div>';
        
        const resDiv = document.createElement('div');
        resDiv.innerHTML = `
            ${recordHtml}
            <div style="font-size:36px; color:#fff; font-weight:bold; text-shadow:0 0 10px #00ffcc;">${score.toLocaleString()}</div>
        `;
        msgArea.appendChild(resDiv);

        msgArea.classList.remove('hidden');
        updateUI();
    }

    function updateUI() {
        scoreEl.textContent = score.toLocaleString();
        ballCountEl.textContent = ballCount;
    }

    window.onload = init;

</script>
</body>
</html>