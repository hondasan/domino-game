<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Domino Critical V33</title>
    <!-- 物理演算ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: white;
            font-family: 'Verdana', sans-serif;
            overflow: hidden;
            touch-action: none;
            height: 100vh;
            width: 100vw;
            user-select: none;
            -webkit-user-select: none;
            position: relative;
            transition: background-color 0.5s; 
        }

        /* --- Static Background --- */
        #bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
            pointer-events: none; 
        }

        .grid-plane {
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            background-image: 
                linear-gradient(rgba(0, 255, 204, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 204, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.5;
        }

        .vignette {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 50%, #000 95%);
            pointer-events: none;
            z-index: 1;
        }

        body.fever-mode {
            background-color: #220011; 
        }
        body.fever-mode .grid-plane {
            background-image: 
                linear-gradient(rgba(255, 50, 50, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 204, 0, 0.1) 1px, transparent 1px);
        }

        /* --- Game Layers --- */
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            display: block;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 10;
        }

        .header {
            padding: 20px;
            text-align: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            position: relative;
            height: 100px;
        }

        #force-finish-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            pointer-events: auto;
            background: rgba(200, 0, 50, 0.6);
            border: 1px solid rgba(255, 100, 100, 0.8);
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            text-transform: uppercase;
            z-index: 9999;
            display: none; 
        }
        #force-finish-btn:active { background: rgba(200, 0, 50, 1); }

        .score-box {
            font-size: 40px;
            font-weight: 900;
            color: #00ffcc;
            text-shadow: 1px 1px 0 #000;
            letter-spacing: 1px;
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sub-info {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            text-transform: uppercase;
        }

        /* リザルト画面 */
        #message-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: auto;
            width: 90%;
            max-width: 420px;
            background: rgba(15, 15, 20, 0.98);
            padding: 25px;
            border-radius: 16px;
            border: 2px solid #444;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 100;
        }

        .btn-start {
            font-size: 24px;
            font-weight: bold;
            color: #000;
            background: #00ffcc;
            padding: 12px 40px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            white-space: nowrap;
            margin-top: 20px;
            width: 100%;
        }

        .jackpot-text {
            position: absolute;
            font-weight: 900;
            pointer-events: none;
            text-shadow: 1px 1px 0 #000;
            white-space: nowrap;
            z-index: 100;
            animation: floatUp 0.8s ease-out forwards;
        }

        .new-record {
            font-size: 20px;
            color: #ff0055;
            font-weight: 900;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        
        #fever-indicator {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 50;
            pointer-events: none;
            display: none;
        }
        
        #fever-mult {
            font-size: 64px;
            font-weight: 900;
            color: #ffcc00;
        }
        
        #fever-timer {
            font-size: 32px;
            color: #fff;
            font-weight: bold;
            margin-top: 5px;
            font-family: 'Courier New', monospace;
        }

        #fever-extend {
            font-size: 18px;
            color: #00ffcc;
            margin-top: 5px;
            font-weight: bold;
            letter-spacing: 2px;
        }
        
        body.fever-mode #fever-indicator {
            display: block;
        }

        /* 統計情報 */
        .stats-container {
            width: 100%;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            box-sizing: border-box;
        }

        .total-balls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        .total-balls .label { color: #ccc; font-weight: bold; font-size: 14px; }
        .total-balls .value { color: #00ffcc; font-size: 22px; font-weight: 900; font-family: 'Courier New', monospace; }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px 20px;
            width: 100%;
            font-size: 14px;
            text-align: left;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 4px;
        }

        .stat-label { color: #888; font-size: 12px; text-transform: uppercase; }
        .stat-value { font-weight: bold; color: #fff; font-size: 16px; font-family: 'Courier New', monospace; }
        .stat-value.god { color: #d0f; text-shadow: 0 0 5px rgba(221, 0, 255, 0.5); font-size: 18px; }
        .stat-value.rare { color: #fc0; }

        @keyframes floatUp {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(1.0); opacity: 0; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="bg-layer">
        <div class="grid-plane"></div>
        <div class="vignette"></div>
    </div>

    <div id="ui-layer">
        <div class="header">
            <div id="score" class="score-box">0</div>
            <div class="sub-info">
                Best: <span id="high-score">0</span><br>
                Balls: <span id="ball-count">0</span> (Limitless)
            </div>
            <button id="force-finish-btn">FINISH</button>
        </div>
        <div id="fever-indicator">
            <div id="fever-mult">FEVER x2</div>
            <div id="fever-timer">3.00s</div>
            <div id="fever-extend">EXTEND: +0</div>
        </div>
        <div id="message-area">
            <button id="start-btn" class="btn-start">TAP TO START</button>
            <div style="margin-top:15px; font-size:11px; color:#888;">
                V33: SUPER JP 50 & LITE PHYSICS
            </div>
        </div>
    </div>

<script>
    // --- CONFIG V33 ---
    const CONFIG = {
        // 確率
        superJackpotChance: 0.0005, // 0.05%
        miniJackpotChance: 0.01,    // 1.0%
        x1000Chance: 0.0002,        // 0.02%
        x100Chance: 0.005,          // 0.5%
        splitChance: 0.20,         
        
        // Super JP個数調整
        superJackpotCount: 50,      // 100 -> 50 に減量して軽量化
        
        // FEVER
        feverBaseDuration: 1000,
        feverMaxDuration: 10000,
        feverRefillInterval: 500,   
        
        feverProbTable: [
            { mult: 2,    prob: 0.60 },
            { mult: 5,    prob: 0.30 },
            { mult: 10,   prob: 0.08 },
            { mult: 50,   prob: 0.015 },
            { mult: 100,  prob: 0.004 },
            { mult: 1000, prob: 0.001 } 
        ],
        
        ballSize: 5.0,      
        pegSize: 4.0,
        gravity: 1.1,
        bounciness: 0.8,
        
        baseScore: 100,
        x100Multiplier: 100,
        x1000Multiplier: 1000
    };

    const PALETTE = [
        { color: '#00ffff', note: 0,  type: 'sine' },     
        { color: '#00ffaa', note: 2,  type: 'sine' },     
        { color: '#ffff00', note: 4,  type: 'triangle' }, 
        { color: '#ffaa00', note: 7,  type: 'sine' },     
        { color: '#ff0055', note: 9,  type: 'triangle' }, 
        { color: '#aa00ff', note: 12, type: 'sine' },     
        { color: '#ffffff', note: 14, type: 'square' }    
    ];

    let engine, render, runner, world;
    let score = 0;
    let highScore = parseInt(localStorage.getItem('domino_critical_highscore_v17')) || 0;
    
    let isPlaying = false;
    let hasStarted = false; 
    let ballCount = 0;
    let audioCtx = null;
    
    let isFever = false;
    let feverTimeRemaining = 0;
    let feverRefillTimer = 0;
    let currentFeverMultiplier = 1;
    let feverExtendCount = 0;
    
    // 軽量化用フレームカウンタ
    let frameCounter = 0;

    let gameStats = {
        totalBalls: 0,
        god: 0,
        superJp: 0,
        x100: 0,
        mini: 0
    };

    const scoreEl = document.getElementById('score');
    const highScoreEl = document.getElementById('high-score');
    const ballCountEl = document.getElementById('ball-count');
    const startBtn = document.getElementById('start-btn');
    const msgArea = document.getElementById('message-area');
    const finishBtn = document.getElementById('force-finish-btn');
    const feverMultEl = document.getElementById('fever-mult');
    const feverTimerEl = document.getElementById('fever-timer');
    const feverExtendEl = document.getElementById('fever-extend');

    highScoreEl.textContent = highScore.toLocaleString();

    const { Engine, Render, Runner, Bodies, Composite, Events, Body } = Matter;

    // --- Sound System ---
    const Sound = {
        bgmNode: null,
        nextNoteTime: 0,
        beatCount: 0,
        isPlayingBGM: false,
        tempo: 135, 
        lastPlayTime: 0, 

        init: () => {
            if (!audioCtx) {
                const AC = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AC();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        },
        
        playTone: (noteIndex, waveType, ballType) => {
            if (!audioCtx) return;
            const now = audioCtx.currentTime;
            
            const isRare = (ballType === 'x100' || ballType === 'x1000');
            
            // サウンドスロットリング (さらに少し厳しく調整)
            if (!isRare && (now - Sound.lastPlayTime < 0.06)) {
                return;
            }
            Sound.lastPlayTime = now;

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            if (ballType === 'x1000') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(2000, now);
                osc.frequency.exponentialRampToValueAtTime(1000, now + 0.3);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
            } else if (ballType === 'x100') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(880, now);
                osc.frequency.linearRampToValueAtTime(1760, now + 0.1); 
                gain.gain.setValueAtTime(0.15, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
            } else {
                const baseFreq = 523.25;
                const freq = baseFreq * Math.pow(2, noteIndex / 12);
                osc.type = waveType || 'sine';
                osc.frequency.setValueAtTime(freq, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            }

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(now + 0.6);
        },

        playJackpot: (type) => {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;

            const playOsc = (type, freq, start, dur, vol, slideTo = null) => {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = type;
                o.frequency.setValueAtTime(freq, start);
                if (slideTo) {
                    o.frequency.exponentialRampToValueAtTime(slideTo, start + dur);
                }
                g.gain.setValueAtTime(vol, start);
                g.gain.exponentialRampToValueAtTime(0.001, start + dur);
                o.connect(g);
                g.connect(audioCtx.destination);
                o.start(start);
                o.stop(start + dur + 0.1);
            };

            if(type === 'super') {
                playOsc('sawtooth', 200, t, 1.2, 0.1, 4000); 
                const notes = [880, 1108, 1318, 1760]; 
                for(let i=0; i<16; i++) {
                    playOsc('square', notes[i%4], t + i*0.06, 0.05, 0.05);
                }
                playOsc('sine', 100, t, 1.5, 0.3, 30);

            } else if (type === 'x1000') {
                const freqs = [523.25, 659.25, 783.99, 987.77, 1174.66];
                freqs.forEach((f, i) => {
                    playOsc('triangle', f, t, 2.0, 0.05); 
                    playOsc('sine', f * 1.01, t, 2.0, 0.05); 
                });
                playOsc('sine', 2093.00, t, 2.5, 0.03);

            } else if (type === 'x100') {
                const notes = [523.25, 659.25, 783.99, 1046.50]; 
                notes.forEach((f, i) => {
                     playOsc('sine', f, t + i*0.05, 0.1, 0.1);
                });

            } else {
                playOsc('sine', 1046.50, t, 0.2, 0.1);
                playOsc('sine', 1567.98, t+0.1, 0.3, 0.1); 
                playOsc('square', 2093.00, t+0.2, 0.4, 0.05); 
            }
        },

        playFeverStart: (highVal) => {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = 'sawtooth';
            const basePitch = highVal ? 1200 : 800;
            o.frequency.setValueAtTime(basePitch, t);
            o.frequency.linearRampToValueAtTime(basePitch * 1.5, t + 0.2);
            o.frequency.linearRampToValueAtTime(basePitch, t + 0.4);
            g.gain.setValueAtTime(0.1, t);
            g.gain.linearRampToValueAtTime(0, t + 0.5);
            o.connect(g);
            g.connect(audioCtx.destination);
            o.start(t);
            o.stop(t + 0.5);
        },
        
        playFeverUpgrade: () => {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = 'square';
            o.frequency.setValueAtTime(1000, t);
            o.frequency.exponentialRampToValueAtTime(4000, t + 0.3);
            g.gain.setValueAtTime(0.1, t);
            g.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
            o.connect(g);
            g.connect(audioCtx.destination);
            o.start(t);
            o.stop(t + 0.3);
        },

        startFeverBGM: () => {
            if (!audioCtx || Sound.isPlayingBGM) return;
            Sound.isPlayingBGM = true;
            Sound.nextNoteTime = audioCtx.currentTime;
            Sound.beatCount = 0;
            Sound.scheduler();
        },

        stopFeverBGM: () => {
            Sound.isPlayingBGM = false;
            if(Sound.timerID) clearTimeout(Sound.timerID);
        },

        scheduler: () => {
            if (!Sound.isPlayingBGM) return;
            while (Sound.nextNoteTime < audioCtx.currentTime + 0.1) {
                Sound.playBeat(Sound.nextNoteTime, Sound.beatCount);
                Sound.nextNoteTime += 60.0 / Sound.tempo / 4; 
                Sound.beatCount++;
            }
            Sound.timerID = setTimeout(Sound.scheduler, 25);
        },

        playBeat: (time, beat) => {
            if (beat % 4 === 0) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(150, time);
                osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
                gain.gain.setValueAtTime(0.3, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.5);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(time);
                osc.stop(time + 0.5);
            }
            if ((beat + 2) % 4 === 0) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(60, time); 
                gain.gain.setValueAtTime(0.0, time);
                gain.gain.linearRampToValueAtTime(0.15, time + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.3);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(time);
                osc.stop(time + 0.3);
            }
            if (beat % 1 === 0) {
                const bufferSize = audioCtx.sampleRate * 0.05; 
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                const gain = audioCtx.createGain();
                const vol = (beat % 2 === 0) ? 0.03 : 0.06;
                gain.gain.setValueAtTime(vol, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
                noise.connect(gain);
                gain.connect(audioCtx.destination);
                noise.start(time);
            }
        }
    };

    function init() {
        // --- 物理演算の超軽量化 ---
        engine = Engine.create({
            positionIterations: 4, // 5->4
            velocityIterations: 2, // 3->2
            enableSleeping: true   // スリープ有効化（重要）
        });
        world = engine.world;
        engine.gravity.y = CONFIG.gravity;

        render = Render.create({
            element: document.body,
            engine: engine,
            options: {
                width: window.innerWidth,
                height: window.innerHeight,
                wireframes: false,
                background: 'transparent', 
                pixelRatio: 1 
            }
        });
        render.canvas.id = "game-canvas";
        
        createStage();

        Events.on(engine, 'collisionStart', handleCollision);
        Events.on(engine, 'beforeUpdate', handleGameLoop);
        
        Render.run(render);
        runner = Runner.create();
        Runner.run(runner, engine);

        window.addEventListener('resize', () => {
            render.canvas.width = window.innerWidth;
            render.canvas.height = window.innerHeight;
            if(!isPlaying) createStage();
        });

        startBtn.addEventListener('click', startGame);
        finishBtn.addEventListener('click', () => { if(isPlaying) endGame(); });
    }

    function createStage() {
        const bodies = Composite.allBodies(world);
        const stageBodies = bodies.filter(b => b.label === 'peg' || b.label === 'wall');
        Composite.remove(world, stageBodies);
        createPegs();
        createWalls();
    }

    function createPegs() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        if (width < 100) return;

        const cols = Math.floor(width / 30); 
        const rows = Math.floor(height / 45);
        const startY = 130; 
        
        for (let r = 0; r < rows - 1; r++) {
            for (let c = 0; c < cols + 1; c++) {
                const offset = (r % 2 === 0) ? 0 : 15;
                const x = (c * 30) + offset;
                const y = startY + (r * 45);
                
                if (x > 20 && x < width - 20) {
                    const peg = Bodies.circle(x, y, CONFIG.pegSize, {
                        isStatic: true, label: 'peg', restitution: 0.8, 
                        render: { 
                            fillStyle: '#004444', 
                            strokeStyle: '#00ffcc', 
                            lineWidth: 2
                        }
                    });
                    Composite.add(world, peg);
                }
            }
        }
    }

    function createWalls() {
        const w = window.innerWidth;
        const h = window.innerHeight;
        const opts = { isStatic: true, label: 'wall', render: { visible: false } }; 
        Composite.add(world, [
            Bodies.rectangle(0, h/2, 20, h, opts),
            Bodies.rectangle(w, h/2, 20, h, opts)
        ]);
    }

    function startGame() {
        if (isPlaying) return;
        Sound.init();
        cleanupBalls();
        createStage();
        
        score = 0;
        ballCount = 0;
        hasStarted = false;
        isPlaying = true;
        
        isFever = false;
        feverTimeRemaining = 0;
        feverRefillTimer = 0;
        currentFeverMultiplier = 1;
        feverExtendCount = 0;
        document.body.classList.remove('fever-mode');
        
        // Reset Stats
        gameStats = { totalBalls: 0, god: 0, superJp: 0, x100: 0, mini: 0 };
        
        updateUI();
        
        msgArea.classList.add('hidden');
        finishBtn.style.display = 'block'; 
        
        spawnBall(window.innerWidth / 2, 40, 'master');
        hasStarted = true;
    }

    function cleanupBalls() {
        const bodies = Composite.allBodies(world);
        const balls = bodies.filter(b => b.label === 'ball');
        if(balls.length > 0) Composite.remove(world, balls);
    }

    function startFever() {
        let r = Math.random();
        let selectedMult = 2;
        let cumulative = 0;
        
        for (let item of CONFIG.feverProbTable) {
            cumulative += item.prob;
            if (r < cumulative) {
                selectedMult = item.mult;
                break;
            }
        }

        if (!isFever) {
            Sound.startFeverBGM();
            feverRefillTimer = 0; 
        }

        feverTimeRemaining += CONFIG.feverBaseDuration;
        if (feverTimeRemaining > CONFIG.feverMaxDuration) {
            feverTimeRemaining = CONFIG.feverMaxDuration;
        }

        if (isFever) {
            feverExtendCount++;
        }

        let upgraded = false;
        if (selectedMult > currentFeverMultiplier) {
            currentFeverMultiplier = selectedMult;
            upgraded = true;
        }

        if (upgraded && isFever) {
            Sound.playFeverUpgrade(); 
        } else if (!isFever) {
            Sound.playFeverStart(selectedMult >= 50); 
        }

        isFever = true;
        document.body.classList.add('fever-mode');
        
        updateFeverUI();
    }

    function updateFeverUI() {
        if (isFever) {
            feverMultEl.textContent = `FEVER x${currentFeverMultiplier}`;
            feverTimerEl.textContent = (feverTimeRemaining / 1000).toFixed(2) + 's';
            feverExtendEl.textContent = `EXTEND: +${feverExtendCount}`;
            
            if (currentFeverMultiplier >= 50) {
                feverMultEl.style.color = '#ff0055';
            } else if (currentFeverMultiplier >= 10) {
                feverMultEl.style.color = '#ffcc00';
            } else {
                feverMultEl.style.color = '#00ffcc';
            }
        }
    }

    function endFever() {
        isFever = false;
        feverTimeRemaining = 0;
        currentFeverMultiplier = 1;
        feverExtendCount = 0;
        document.body.classList.remove('fever-mode');
        Sound.stopFeverBGM();
    }

    function spawnBall(x, y, type = 'normal') {
        if (!isPlaying) return;

        let style;
        let ballType = type; 
        
        if (type === 'master') {
            style = { color: '#ffffff', note: 12, type: 'square' };
            ballType = 'normal'; 
        } else if (type === 'super') {
            style = { color: '#ffffff', note: 14, type: 'sawtooth' }; 
            ballType = 'normal'; 
        } else if (type === 'mini') {
            style = { color: '#ffcc00', note: 9, type: 'square' }; 
            ballType = 'normal';
        } else if (type === 'x1000') {
            style = { color: '#aa00ff', note: 20, type: 'sine' }; 
        } else if (type === 'x100') {
            style = { color: '#ff0000', note: -5, type: 'sawtooth' }; 
        } else {
            style = PALETTE[Math.floor(Math.random() * PALETTE.length)];
        }

        const ball = Bodies.circle(x, y, CONFIG.ballSize, {
            restitution: CONFIG.bounciness,
            friction: 0.000,
            frictionAir: 0.005,
            label: 'ball',
            render: { 
                fillStyle: style.color,
                strokeStyle: (ballType === 'x1000') ? '#ffffff' : (ballType === 'x100' ? '#ffff00' : 'transparent'),
                lineWidth: (ballType === 'x1000' || ballType === 'x100') ? 2 : 0
            },
            plugin: { 
                note: style.note, 
                wave: style.type, 
                ballType: ballType,
            }
        });

        Body.setVelocity(ball, { 
            x: (Math.random() - 0.5) * 8, y: (Math.random() - 0.5) * 8 
        });

        Composite.add(world, ball);
        
        gameStats.totalBalls++;
    }

    function showFloatingText(text, x, y, type) {
        if(!isPlaying) return;
        const div = document.createElement('div');
        div.className = 'jackpot-text';
        div.innerText = text;
        div.style.left = x + 'px';
        div.style.top = y + 'px';
        
        if(type === 'super') {
            div.style.fontSize = '36px'; div.style.color = '#fff'; div.style.textShadow = '0 0 20px gold';
        } else if (type === 'x1000') {
            div.style.fontSize = '40px'; div.style.color = '#aa00ff'; div.style.textShadow = '0 0 20px #fff';
        } else if (type === 'x100') {
            div.style.fontSize = '28px'; div.style.color = '#ff0000'; div.style.textShadow = '0 0 10px yellow';
        } else if (type === 'mini') {
            div.style.fontSize = '24px'; div.style.color = '#ffcc00';
        } else {
            div.style.fontSize = '16px'; div.style.color = '#fff';
        }
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1200);
    }

    function handleCollision(event) {
        if (!isPlaying) return;
        event.pairs.forEach(pair => {
            const bodyA = pair.bodyA;
            const bodyB = pair.bodyB;

            if ((bodyA.label === 'ball' && bodyB.label === 'peg') || 
                (bodyB.label === 'ball' && bodyA.label === 'peg')) {
                
                const ball = bodyA.label === 'ball' ? bodyA : bodyB;
                const peg = bodyA.label === 'peg' ? bodyA : bodyB;

                let hitScore = CONFIG.baseScore;
                const bType = ball.plugin ? ball.plugin.ballType : 'normal';

                if (bType === 'x1000') {
                    hitScore = CONFIG.baseScore * CONFIG.x1000Multiplier;
                } else if (bType === 'x100') {
                    hitScore = CONFIG.baseScore * CONFIG.x100Multiplier;
                }
                
                if (isFever) {
                    hitScore *= currentFeverMultiplier;
                }
                
                if(ball.plugin) Sound.playTone(ball.plugin.note, ball.plugin.wave, bType);
                score += hitScore;

                if (Math.random() > 0.6 || bType === 'x1000') {
                    peg.render.fillStyle = ball.render.fillStyle;
                    peg.render.strokeStyle = '#fff';
                    setTimeout(() => { 
                        peg.render.fillStyle = '#004444'; 
                        peg.render.strokeStyle = '#00ffcc';
                    }, 100);
                }

                const rand = Math.random();
                
                if (rand < CONFIG.superJackpotChance) {
                    gameStats.superJp++;
                    Sound.playJackpot('super');
                    startFever(); 
                    score += 100000;
                    showFloatingText("SUPER JACKPOT!!!", window.innerWidth/2, window.innerHeight/3, 'super');
                    let created = 0;
                    const burst = () => {
                        if (!isPlaying) return; 
                        // Super JP個数調整 (50)
                        for(let k=0; k<5; k++) { 
                            if(created >= CONFIG.superJackpotCount) return;
                            const spawnT = (bType !== 'normal' && Math.random() < 0.1) ? bType : 'super';
                            spawnBall(ball.position.x, ball.position.y, spawnT);
                            created++;
                        }
                        if(created < CONFIG.superJackpotCount) requestAnimationFrame(burst);
                    };
                    burst();
                } 
                else if (rand < CONFIG.superJackpotChance + CONFIG.x1000Chance) {
                    gameStats.god++;
                    Sound.playJackpot('x1000');
                    startFever(); 
                    showFloatingText("GOD BALL x1000", ball.position.x, ball.position.y, 'x1000');
                    spawnBall(ball.position.x, ball.position.y, 'x1000');
                }
                else if (rand < CONFIG.superJackpotChance + CONFIG.x1000Chance + CONFIG.x100Chance) {
                    gameStats.x100++;
                    Sound.playJackpot('x100');
                    startFever(); 
                    showFloatingText("x100 BALL!!", ball.position.x, ball.position.y, 'x100');
                    spawnBall(ball.position.x, ball.position.y, 'x100');
                }
                else if (rand < CONFIG.superJackpotChance + CONFIG.x1000Chance + CONFIG.x100Chance + CONFIG.miniJackpotChance) {
                    gameStats.mini++;
                    Sound.playJackpot('mini');
                    score += 5000;
                    showFloatingText("LUCKY 10!", ball.position.x, ball.position.y, 'mini');
                    for(let i=0; i<10; i++) {
                        spawnBall(ball.position.x, ball.position.y, bType === 'normal' ? 'mini' : bType);
                    }
                }
                else {
                    const threshold = CONFIG.superJackpotChance + CONFIG.x1000Chance + CONFIG.x100Chance + CONFIG.miniJackpotChance + CONFIG.splitChance;
                    
                    if (rand < threshold) {
                        score += 500;
                        spawnBall(ball.position.x, ball.position.y, bType);
                    }
                }
            }
        });
    }

    function handleGameLoop() {
        if (!isPlaying) return;

        // --- 軽量化されたループ ---
        // 全ボディ走査を毎フレーム行わず、間引く (5フレームに1回)
        frameCounter++;
        
        if (isFever) {
            feverTimeRemaining -= engine.timing.lastDelta;
            feverRefillTimer += engine.timing.lastDelta;

            if (feverRefillTimer >= CONFIG.feverRefillInterval) {
                feverRefillTimer = 0;
                const spawnX = window.innerWidth / 2 + (Math.random() - 0.5) * 60;
                spawnBall(spawnX, -20, 'normal');
            }

            if (feverTimeRemaining <= 0) {
                endFever();
            }
        }

        // 間引き処理
        if (frameCounter % 5 === 0) {
            const bodies = Composite.allBodies(world);
            const h = window.innerHeight;
            let count = 0;
            
            for (let i = 0; i < bodies.length; i++) {
                const b = bodies[i];
                if (b.label === 'ball') {
                    if(b.position.y > h + 50) {
                        Composite.remove(world, b);
                    } else {
                        count++;
                    }
                }
            }
            ballCount = count;
            
            if (hasStarted && ballCount === 0 && !isFever) {
                endGame();
            }
        }
        
        if (engine.timing.timestamp % 50 < 20) {
            updateUI();
            updateFeverUI();
        }
    }

    function endGame() {
        if (!isPlaying) return;
        isPlaying = false; 
        endFever(); 
        finishBtn.style.display = 'none'; 

        let isNewRecord = false;
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('domino_critical_highscore_v17', highScore);
            highScoreEl.textContent = Number(highScore).toLocaleString();
            isNewRecord = true;
        }

        startBtn.textContent = "RETRY";
        msgArea.innerHTML = '';
        msgArea.appendChild(startBtn);
        
        let recordHtml = isNewRecord ? '<div class="new-record">NEW RECORD!!</div>' : '<div style="margin-top:5px; font-size:14px; color:#aaa; font-weight:bold;">RESULT</div>';
        
        const resDiv = document.createElement('div');
        resDiv.style.width = '100%';
        resDiv.innerHTML = `
            ${recordHtml}
            <div style="font-size:42px; color:#fff; font-weight:900; text-shadow:0 0 15px #00ffcc; margin:10px 0; letter-spacing:1px;">${score.toLocaleString()}</div>
            
            <div class="stats-container">
                <div class="total-balls">
                    <span class="label">TOTAL BALLS</span>
                    <span class="value">${gameStats.totalBalls.toLocaleString()}</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item"><span class="stat-label">God (x1000)</span><span class="stat-value god">${gameStats.god}</span></div>
                    <div class="stat-item"><span class="stat-label">Super JP</span><span class="stat-value rare">${gameStats.superJp}</span></div>
                    <div class="stat-item"><span class="stat-label">x100 Ball</span><span class="stat-value rare">${gameStats.x100}</span></div>
                    <div class="stat-item"><span class="stat-label">Mini JP</span><span class="stat-value">${gameStats.mini}</span></div>
                </div>
            </div>
        `;
        msgArea.appendChild(resDiv);

        msgArea.classList.remove('hidden');
        updateUI();
    }

    function updateUI() {
        scoreEl.textContent = score.toLocaleString();
        ballCountEl.textContent = ballCount;
    }

    window.onload = init;

</script>
</body>
</html>